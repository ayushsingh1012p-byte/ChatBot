{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
        crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <title>Document</title>
</head>

<body>
    <div class="container" style="width: 400px; height: 500px;">
        <div class="card" id="chat-box" style="height: 500px;">
            <div class="card-header" style="background-color: rgb(50, 50, 50);color: white;">
                <div class="card-title d-flex align-item-center justify-content-center">
                    <h3>Chatbot</h3>
                </div>
            </div>
            <div class="card-body d-flex flex-column"
                style="background-color: rgb(74, 74, 74); gap: 10px; overflow:auto;">
                {% for msg in messages %}
                <div class="{{ msg.sender }}">{{ msg.message }}</div>
                {% endfor %}


            </div>
            <div class="card-footer d-flex" style="background-color: rgb(50, 50, 50);">
                <input type="text" class="form-control me-2" id="user-input"
                    style="background-color: rgb(50, 50, 50); color: white; border-color: aquamarine;">
                <button class="btn btn-success" onclick="sendMessage()">Send</button>
            </div>

        </div>
    </div>

</body>
<script>
    function sendMessage() {
        const input = document.getElementById("user-input");
        const message = input.value.trim();
        if (!message) return;

        const chatBody = document.querySelector(".card-body");

      
        const userMsg = document.createElement("div");
        userMsg.className = "user";
        userMsg.textContent = message;
        chatBody.appendChild(userMsg);
        input.value = "";

        // ü§ñ Thinking animation
        const botMsg = document.createElement("div");
        botMsg.className = "bot thinking";
        botMsg.innerHTML = `
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
        `;
        chatBody.appendChild(botMsg);
        chatBody.scrollTop = chatBody.scrollHeight;

        
        fetch("{% url 'chat_api' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: `message=${encodeURIComponent(message)}`
        })
            .then(response => response.json())
            .then(data => {
                // Replace thinking dots with actual reply
                botMsg.classList.remove("thinking");
                botMsg.textContent = data.reply || "‚ö†Ô∏è (No response)";
                chatBody.scrollTop = chatBody.scrollHeight;
            })
            .catch(error => {
                botMsg.classList.remove("thinking");
                botMsg.textContent = "‚ö†Ô∏è Error connecting to server.";
                console.error(error);
            });
    }
</script>


</html>